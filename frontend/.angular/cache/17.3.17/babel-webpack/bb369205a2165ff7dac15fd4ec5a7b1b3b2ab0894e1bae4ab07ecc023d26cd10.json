{"ast":null,"code":"import { inject } from '@angular/core';\nimport { CommonModule } from '@angular/common';\nimport { FormBuilder, ReactiveFormsModule, Validators } from '@angular/forms';\nimport { ApiService } from '../services/api';\nimport { MatFormFieldModule } from '@angular/material/form-field';\nimport { MatInputModule } from '@angular/material/input';\nimport { MatSelectModule } from '@angular/material/select';\nimport { MatButtonModule } from '@angular/material/button';\nimport { MatIconModule } from '@angular/material/icon';\nimport { MatDatepickerModule } from '@angular/material/datepicker';\nimport { MatNativeDateModule } from '@angular/material/core';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/common\";\nimport * as i2 from \"@angular/forms\";\nimport * as i3 from \"@angular/material/form-field\";\nimport * as i4 from \"@angular/material/input\";\nimport * as i5 from \"@angular/material/select\";\nimport * as i6 from \"@angular/material/core\";\nimport * as i7 from \"@angular/material/button\";\nimport * as i8 from \"@angular/material/icon\";\nimport * as i9 from \"@angular/material/datepicker\";\nfunction SalesNewComponent_div_19_mat_option_7_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"mat-option\", 16);\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const p_r5 = ctx.$implicit;\n    i0.ɵɵproperty(\"value\", p_r5.id);\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate2(\"\", p_r5.name, \" (stock: \", p_r5.stock, \")\");\n  }\n}\nfunction SalesNewComponent_div_19_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r2 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"div\", 13)(1, \"mat-form-field\", 14)(2, \"mat-label\");\n    i0.ɵɵtext(3, \"Producto\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(4, \"mat-select\", 15);\n    i0.ɵɵlistener(\"selectionChange\", function SalesNewComponent_div_19_Template_mat_select_selectionChange_4_listener() {\n      const i_r3 = i0.ɵɵrestoreView(_r2).index;\n      const ctx_r3 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r3.onProductChange(i_r3));\n    });\n    i0.ɵɵelementStart(5, \"mat-option\", 16);\n    i0.ɵɵtext(6, \"-- Producto --\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtemplate(7, SalesNewComponent_div_19_mat_option_7_Template, 2, 3, \"mat-option\", 17);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(8, \"mat-form-field\", 4)(9, \"mat-label\");\n    i0.ɵɵtext(10, \"Cantidad\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(11, \"input\", 18);\n    i0.ɵɵlistener(\"input\", function SalesNewComponent_div_19_Template_input_input_11_listener() {\n      const i_r3 = i0.ɵɵrestoreView(_r2).index;\n      const ctx_r3 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r3.recalc(i_r3));\n    });\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(12, \"mat-form-field\", 4)(13, \"mat-label\");\n    i0.ɵɵtext(14, \"Precio Unit\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(15, \"input\", 19);\n    i0.ɵɵlistener(\"input\", function SalesNewComponent_div_19_Template_input_input_15_listener() {\n      const i_r3 = i0.ɵɵrestoreView(_r2).index;\n      const ctx_r3 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r3.recalc(i_r3));\n    });\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(16, \"span\");\n    i0.ɵɵtext(17);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(18, \"button\", 20);\n    i0.ɵɵlistener(\"click\", function SalesNewComponent_div_19_Template_button_click_18_listener() {\n      const i_r3 = i0.ɵɵrestoreView(_r2).index;\n      const ctx_r3 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r3.removeItem(i_r3));\n    });\n    i0.ɵɵelementStart(19, \"mat-icon\");\n    i0.ɵɵtext(20, \"delete\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(21, \" Eliminar\");\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const g_r6 = ctx.$implicit;\n    const ctx_r3 = i0.ɵɵnextContext();\n    i0.ɵɵproperty(\"formGroup\", g_r6);\n    i0.ɵɵadvance(5);\n    i0.ɵɵproperty(\"value\", null);\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"ngForOf\", ctx_r3.products);\n    i0.ɵɵadvance(10);\n    i0.ɵɵtextInterpolate1(\"Subtotal: \", g_r6.value.subtotal, \"\");\n  }\n}\nexport let SalesNewComponent = /*#__PURE__*/(() => {\n  class SalesNewComponent {\n    constructor() {\n      this.fb = inject(FormBuilder);\n      this.api = inject(ApiService);\n      this.products = [];\n      this.total = '0.00';\n      this.form = this.fb.group({\n        payment_method: [''],\n        date: [''],\n        items: this.fb.array([])\n      });\n    }\n    ngOnInit() {\n      this.api.listProducts().subscribe(p => this.products = p);\n      this.addItem();\n    }\n    get items() {\n      return this.form.get('items');\n    }\n    addItem() {\n      this.items.push(this.fb.group({\n        productId: [null, Validators.required],\n        quantity: [1, [Validators.required, Validators.min(1)]],\n        unitPrice: ['0.00', Validators.required],\n        subtotal: ['0.00']\n      }));\n    }\n    removeItem(i) {\n      this.items.removeAt(i);\n      this.recalc();\n    }\n    onProductChange(i) {\n      const g = this.items.at(i);\n      const productId = g.get('productId').value;\n      const product = this.products.find(p => p.id === productId);\n      if (product) {\n        g.get('unitPrice').setValue(product.price);\n        this.recalc(i);\n      }\n    }\n    recalc(idx) {\n      for (let i = 0; i < this.items.length; i++) {\n        if (idx !== undefined && idx !== i) continue;\n        const g = this.items.at(i);\n        const q = Number(g.value.quantity || 0);\n        const up = Number(g.value.unitPrice || 0);\n        const sub = (q * up).toFixed(2);\n        g.patchValue({\n          subtotal: sub\n        }, {\n          emitEvent: false\n        });\n      }\n      const total = this.items.controls.reduce((acc, g) => acc + Number(g.value.subtotal || 0), 0);\n      this.total = total.toFixed(2);\n    }\n    submit() {\n      const v = this.form.getRawValue();\n      const items = v.items.filter(i => i.productId).map(i => ({\n        productId: Number(i.productId),\n        quantity: Number(i.quantity),\n        unitPrice: typeof i.unitPrice === 'number' ? i.unitPrice.toFixed(2) : String(i.unitPrice)\n      }));\n      if (!items.length) {\n        alert('Agrega al menos un ítem con producto.');\n        return;\n      }\n      const payload = {\n        payment_method: v.payment_method || undefined,\n        date: v.date || undefined,\n        items\n      };\n      this.api.createSale(payload).subscribe({\n        next: () => {\n          this.form.reset({\n            items: []\n          });\n          this.items.clear();\n          this.addItem();\n          this.total = '0.00';\n          alert('Venta creada');\n        },\n        error: err => {\n          const msg = err?.error?.message;\n          const text = Array.isArray(msg) ? msg.join('\\n') : msg || err.message || 'Error al crear la venta';\n          alert(text);\n        }\n      });\n    }\n    static {\n      this.ɵfac = function SalesNewComponent_Factory(t) {\n        return new (t || SalesNewComponent)();\n      };\n    }\n    static {\n      this.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n        type: SalesNewComponent,\n        selectors: [[\"app-sales-new\"]],\n        standalone: true,\n        features: [i0.ɵɵStandaloneFeature],\n        decls: 31,\n        vars: 6,\n        consts: [[\"dt\", \"\"], [1, \"card\"], [2, \"display\", \"grid\", \"gap\", \"12px\", 3, \"ngSubmit\", \"formGroup\"], [2, \"display\", \"flex\", \"gap\", \"12px\", \"align-items\", \"center\", \"flex-wrap\", \"wrap\"], [\"appearance\", \"outline\"], [\"matInput\", \"\", \"placeholder\", \"Efectivo / Tarjeta\", \"formControlName\", \"payment_method\"], [\"matInput\", \"\", \"formControlName\", \"date\", 3, \"matDatepicker\"], [\"matSuffix\", \"\", 3, \"for\"], [\"style\", \"display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap;\", 3, \"formGroup\", 4, \"ngFor\", \"ngForOf\"], [\"type\", \"button\", \"mat-raised-button\", \"\", \"color\", \"primary\", 3, \"click\"], [2, \"text-align\", \"right\", \"font-weight\", \"bold\"], [\"mat-raised-button\", \"\", \"color\", \"primary\", \"type\", \"submit\", 3, \"disabled\"], [2, \"margin-right\", \"4px\"], [2, \"display\", \"flex\", \"gap\", \"8px\", \"align-items\", \"center\", \"margin-bottom\", \"8px\", \"flex-wrap\", \"wrap\", 3, \"formGroup\"], [\"appearance\", \"outline\", 2, \"min-width\", \"260px\"], [\"formControlName\", \"productId\", 3, \"selectionChange\"], [3, \"value\"], [3, \"value\", 4, \"ngFor\", \"ngForOf\"], [\"matInput\", \"\", \"type\", \"number\", \"formControlName\", \"quantity\", 3, \"input\"], [\"matInput\", \"\", \"type\", \"number\", \"step\", \"0.01\", \"formControlName\", \"unitPrice\", 3, \"input\"], [\"type\", \"button\", \"mat-button\", \"\", 3, \"click\"]],\n        template: function SalesNewComponent_Template(rf, ctx) {\n          if (rf & 1) {\n            const _r1 = i0.ɵɵgetCurrentView();\n            i0.ɵɵelementStart(0, \"div\", 1)(1, \"h2\");\n            i0.ɵɵtext(2, \"Nueva Venta\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(3, \"form\", 2);\n            i0.ɵɵlistener(\"ngSubmit\", function SalesNewComponent_Template_form_ngSubmit_3_listener() {\n              i0.ɵɵrestoreView(_r1);\n              return i0.ɵɵresetView(ctx.submit());\n            });\n            i0.ɵɵelementStart(4, \"div\", 3)(5, \"mat-form-field\", 4)(6, \"mat-label\");\n            i0.ɵɵtext(7, \"M\\u00E9todo de pago\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelement(8, \"input\", 5);\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(9, \"mat-form-field\", 4)(10, \"mat-label\");\n            i0.ɵɵtext(11, \"Fecha\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelement(12, \"input\", 6)(13, \"mat-datepicker-toggle\", 7)(14, \"mat-datepicker\", null, 0);\n            i0.ɵɵelementEnd()();\n            i0.ɵɵelementStart(16, \"div\", 1)(17, \"h3\");\n            i0.ɵɵtext(18, \"Items\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵtemplate(19, SalesNewComponent_div_19_Template, 22, 4, \"div\", 8);\n            i0.ɵɵelementStart(20, \"button\", 9);\n            i0.ɵɵlistener(\"click\", function SalesNewComponent_Template_button_click_20_listener() {\n              i0.ɵɵrestoreView(_r1);\n              return i0.ɵɵresetView(ctx.addItem());\n            });\n            i0.ɵɵelementStart(21, \"mat-icon\");\n            i0.ɵɵtext(22, \"add\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵtext(23, \" Agregar \\u00EDtem\");\n            i0.ɵɵelementEnd()();\n            i0.ɵɵelementStart(24, \"div\", 10);\n            i0.ɵɵtext(25);\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(26, \"div\")(27, \"button\", 11)(28, \"mat-icon\", 12);\n            i0.ɵɵtext(29, \"check\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵtext(30, \" Crear Venta \");\n            i0.ɵɵelementEnd()()()();\n          }\n          if (rf & 2) {\n            const dt_r7 = i0.ɵɵreference(15);\n            i0.ɵɵadvance(3);\n            i0.ɵɵproperty(\"formGroup\", ctx.form);\n            i0.ɵɵadvance(9);\n            i0.ɵɵproperty(\"matDatepicker\", dt_r7);\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"for\", dt_r7);\n            i0.ɵɵadvance(6);\n            i0.ɵɵproperty(\"ngForOf\", ctx.items.controls);\n            i0.ɵɵadvance(6);\n            i0.ɵɵtextInterpolate1(\"Total: \", ctx.total, \"\");\n            i0.ɵɵadvance(2);\n            i0.ɵɵproperty(\"disabled\", !ctx.items.controls.length);\n          }\n        },\n        dependencies: [CommonModule, i1.NgForOf, ReactiveFormsModule, i2.ɵNgNoValidate, i2.DefaultValueAccessor, i2.NumberValueAccessor, i2.NgControlStatus, i2.NgControlStatusGroup, i2.FormGroupDirective, i2.FormControlName, MatFormFieldModule, i3.MatFormField, i3.MatLabel, i3.MatSuffix, MatInputModule, i4.MatInput, MatSelectModule, i5.MatSelect, i6.MatOption, MatButtonModule, i7.MatButton, MatIconModule, i8.MatIcon, MatDatepickerModule, i9.MatDatepicker, i9.MatDatepickerInput, i9.MatDatepickerToggle, MatNativeDateModule],\n        encapsulation: 2\n      });\n    }\n  }\n  return SalesNewComponent;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}